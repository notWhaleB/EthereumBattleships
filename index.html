<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="web3.min.js"></script>
  <script src="jquery-3.3.1.min.js"></script>
  <style>
    :root {
      --red: #db7093;
      --blue: #6495ed;
      --gray: #e6e6e6;
    }

    html, body {
      max-width: 100vw;
      max-height: 100vh;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    .cell {
      text-align: center;
      height: auto;
      padding: 3px;
      cursor: pointer;
    }

    .cell.selected {
      background-color: yellow;
    }

    .cell.fired {
      background-color: black;
    }

    .cell-content {
      width: 27px;
      height: 27px;
    }

    table {
      border-collapse: collapse;
    }

    .btn {
      height: 32px;
      border: 2px solid var(--blue);
      text-align: center;
      line-height: 32px;
      margin: 10px 3px;
      padding: 0 10px;
      cursor: pointer;
      color: var(--blue)
    }

    .btn:hover {
      background-color: var(--blue);
      color: white;
    }

    th, td {
      border: 2px solid;
    }

    #red-player th, #red-player td {
      border-color: var(--red);
    }

    #red-player .cell.populated > .cell-content {
      background-color: var(--red);
    }

    #blue-player th, #blue-player td {
      border-color: var(--blue);
    }

    #blue-player .cell.populated > .cell-content {
      background-color: var(--blue);
    }

    .field-container {
      width: 350px;
      height: 350px;
    }

    .field {
      background-color: white;
      width: 350px;
      height: 350px;
    }

    .info-bar, .action-bar {
      width: 350px;
      height: 75px;
      text-align: center;
      line-height: 75px;
    }

    .float-left {
      float: left !important;
    }

    .float-right {
      float: right !important;
    }
  </style>
</head>
<body>
  <div style="width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center;">
    <div style="width: 720px; height: 500px; background-color: var(--gray); margin: 0 auto; padding: 0 20px; border-radius: 5px">
      <div data-role="start" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
        <div>
          <label for="account-select" style="display: block; margin: 3px">Account</label>
          <select id="account-select" style="width: 100%"></select>
          <div id="create-game" class="btn">Create New Game</div>
          <hr>
          <label for="address-input" style="display: block; margin: 3px">Game ID (Contract Address)</label>
          <input id="address-input" style="width: calc(100% - 8px)">
          <div id="join" class="btn">Join</div>
        </div>
      </div>
      <div data-role="game" style="display: none;">
        <div id="game-id" style="position: fixed; top: 5px; right: 5px"></div>
        <div id="red-info-bar" class="info-bar float-left"></div>
        <div id="blue-info-bar" class="info-bar float-right"></div>
        <div class="field-container float-left">
          <table id="red-player" class="field"></table>
        </div>
        <div class="field-container float-right">
          <table id="blue-player" class="field"></table>
        </div>
        <div id="red-action-bar" class="action-bar float-left">
          <div class="btn" data-role="action-btn">Submit Field</div>
        </div>
        <div id="blue-action-bar" class="action-bar float-right">
          <div class="btn" data-role="action-btn">Make Shot</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    'use strict';

    $(() => {
      const $redPlayer = $('#red-player');
      const $bluePlayer = $('#blue-player');
      const $createGame = $('#create-game');
      const $join = $('#join');
      const $accountSelect = $('#account-select');
      const $addressInput = $('#address-input');

      const $start = $('div[data-role="start"]');
      const $game = $('div[data-role="game"]');

      const $redInfoBar = $('#red-info-bar');
      const $blueInfoBar = $('#blue-info-bar');

      const $redActionBar = $('#red-action-bar');
      const $blueActionBar = $('#blue-action-bar');

      const web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

      const battleshipsContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"myTurn","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"field","type":"bytes13"}],"name":"setField","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"join","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getPlayersStatus","outputs":[{"name":"inited","type":"bool[2]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getFields","outputs":[{"name":"","type":"bytes13"},{"name":"","type":"bytes13"},{"name":"","type":"bytes13"},{"name":"","type":"bytes13"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"whois","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint8"}],"name":"makeShot","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

      $accountSelect.append(
        web3.eth.accounts.map(n => `<option value="${n}">${n}</option>`)
      );
      let battleshipsContractInstance;

      [$redPlayer, $bluePlayer].forEach($elem => {
        let tds = '';
        for (let i = 0; i !== 10; ++i) {
          tds += '';
        }

        for (let i = 0; i !== 10; ++i) {
          let $tr = $('<tr>');
          for (let j = 0; j !== 10; ++j) {
            $tr.append(`<td class="cell" data-cell-id="${ i * 10 + j }"><div class="cell-content"></div></td>`);
          }

          $elem.append($tr);
        }
      });

      $createGame.click(() => {
        web3.eth.defaultAccount = $accountSelect.val();
        battleshipsContractInstance = battleshipsContract.new({
          data: '0x6060604052341561000f57600080fd5b3360008060028110151561001f57fe5b6002020160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061006c61014e565b604051809103906000f080151561008257600080fd5b60008060028110151561009157fe5b6002020160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506100de61014e565b604051809103906000f08015156100f457600080fd5b6000600160028110151561010457fe5b6002020160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061015f565b6040516104a3806200144e83390190565b6112df806200016f6000396000f300606060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631ed4557f146100885780638673eaab146100b5578063b688a363146100ee578063bec0c1761461011b578063ca6024921461016c578063e7004c891461025a578063f594ab8a14610283575b600080fd5b341561009357600080fd5b61009b6102c1565b604051808215151515815260200191505060405180910390f35b34156100c057600080fd5b6100ec600480803572ffffffffffffffffffffffffffffffffffffff1916906020019091905050610422565b005b34156100f957600080fd5b610101610652565b604051808215151515815260200191505060405180910390f35b341561012657600080fd5b61012e610724565b6040518082600260200280838360005b8381101561015957808201518184015260208101905061013e565b5050505090500191505060405180910390f35b341561017757600080fd5b61017f6107e0565b604051808572ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff191681526020018472ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff191681526020018372ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff191681526020018272ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff1916815260200194505050505060405180910390f35b341561026557600080fd5b61026d610cab565b6040518082815260200191505060405180910390f35b341561028e57600080fd5b6102a7600480803560ff16906020019091905050610d9c565b604051808215151515815260200191505060405180910390f35b60008060006002811015156102d257fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16148061039557506000600160028110151561033e57fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b15156103a057600080fd5b3373ffffffffffffffffffffffffffffffffffffffff1660006103c1611197565b6002811015156103cd57fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561041a576001905061041f565b600090505b90565b600080600060028110151561043357fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806104f657506000600160028110151561049f57fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b151561050157600080fd5b610509610cab565b905060008160028110151561051a57fe5b6002020160000160159054906101000a900460ff1615151561053b57600080fd5b600160008260028110151561054c57fe5b6002020160000160156101000a81548160ff02191690831515021790555060008160028110151561057957fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638673eaab836040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808272ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff19168152602001915050600060405180830381600087803b151561063a57600080fd5b6102c65a03f1151561064b57600080fd5b5050505050565b6000806000600160028110151561066557fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415806106b8575060026106b5610cab565b14155b156106c65760009050610721565b33600060016002811015156106d757fe5b6002020160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600190505b90565b61072c61128a565b60008061073761128a565b61073f610cab565b925060026001840181151561075057fe5b06915060008360028110151561076257fe5b6002020160000160159054906101000a900460ff1681600060028110151561078657fe5b6020020190151590811515815250506000826002811015156107a457fe5b6002020160000160159054906101000a900460ff168160016002811015156107c857fe5b60200201901515908115158152505080935050505090565b6000806000806000806000806002811015156107f857fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806108bb57506000600160028110151561086457fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b15156108c657600080fd5b6108ce610cab565b9150600260016108dc610cab565b018115156108e657fe5b0690506000826002811015156108f857fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166399949b666000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b151561098b57600080fd5b6102c65a03f1151561099c57600080fd5b505050604051805190506000836002811015156109b557fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166336ccfa426000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b1515610a4857600080fd5b6102c65a03f11515610a5957600080fd5b50505060405180519050600083600281101515610a7257fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166336ccfa426000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b1515610b0557600080fd5b6102c65a03f11515610b1657600080fd5b50505060405180519050600084600281101515610b2f57fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166399949b666000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b1515610bc257600080fd5b6102c65a03f11515610bd357600080fd5b5050506040518051905016600084600281101515610bed57fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166336ccfa426000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b1515610c8057600080fd5b6102c65a03f11515610c9157600080fd5b505050604051805190509550955095509550505090919293565b60003373ffffffffffffffffffffffffffffffffffffffff16600080600281101515610cd357fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610d205760009050610d99565b3373ffffffffffffffffffffffffffffffffffffffff1660006001600281101515610d4757fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610d945760019050610d99565b600290505b90565b600080600080600080600281101515610db157fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610e74575060006001600281101515610e1d57fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b1515610e7f57600080fd5b600080600281101515610e8e57fe5b6002020160000160159054906101000a900460ff168015610ed0575060006001600281101515610eba57fe5b6002020160000160159054906101000a900460ff165b1515610edb57600080fd5b6000806000600281101515610eec57fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166381b2b9826000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b1515610f7f57600080fd5b6102c65a03f11515610f9057600080fd5b5050506040518051905060ff1614151515610faa57600080fd5b6000806001600281101515610fbb57fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166381b2b9826000604051602001526040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401602060405180830381600087803b151561104e57600080fd5b6102c65a03f1151561105f57600080fd5b5050506040518051905060ff161415151561107957600080fd5b611081610cab565b925061108b611197565b8314151561109857600080fd5b6002600184018115156110a757fe5b0691506000826002811015156110b957fe5b6002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166317e8bd49866000604051602001526040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808260ff1660ff168152602001915050602060405180830381600087803b151561115d57600080fd5b6102c65a03f1151561116e57600080fd5b505050604051805190509050600460008154809291906001019190505550809350505050919050565b60008060006002811015156111a857fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16148061126b57506000600160028110151561121457fe5b6002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b151561127657600080fd5b600260045481151561128457fe5b06905090565b60408051908101604052806002905b6000151581526020019060019003908161129957905050905600a165627a7a723058203271527cb2b4940932f02e93a2d7da6286f96ef66bb38c3b9d5ec9167abbc5ff00296060604052341561000f57600080fd5b60146000601a6101000a81548160ff021916908360ff1602179055506104698061003a6000396000f30060606040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806317e8bd491461007257806336ccfa42146100b057806381b2b982146101055780638673eaab1461013457806399949b661461016d575b600080fd5b341561007d57600080fd5b610096600480803560ff169060200190919050506101c2565b604051808215151515815260200191505060405180910390f35b34156100bb57600080fd5b6100c36102fc565b604051808272ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff1916815260200191505060405180910390f35b341561011057600080fd5b610118610325565b604051808260ff1660ff16815260200191505060405180910390f35b341561013f57600080fd5b61016b600480803572ffffffffffffffffffffffffffffffffffffff191690602001909190505061033b565b005b341561017857600080fd5b610180610378565b604051808272ffffffffffffffffffffffffffffffffffffff191672ffffffffffffffffffffffffffffffffffffff1916815260200191505060405180910390f35b600060648260ff1610801561020057506101fe6000600d9054906101000a900473010000000000000000000000000000000000000002836103a1565b155b151561020b57600080fd5b61022c600173010000000000000000000000000000000000000002836103fd565b6000600d9054906101000a900473010000000000000000000000000000000000000002176000600d6101000a8154816cffffffffffffffffffffffffff0219169083730100000000000000000000000000000000000000900402179055506102b56000809054906101000a900473010000000000000000000000000000000000000002836103a1565b15156102c457600090506102f7565b60016000601a8282829054906101000a900460ff160392506101000a81548160ff021916908360ff160217905550600190505b919050565b600080600d9054906101000a900473010000000000000000000000000000000000000002905090565b600080601a9054906101000a900460ff16905090565b806000806101000a8154816cffffffffffffffffffffffffff02191690837301000000000000000000000000000000000000009004021790555050565b60008060009054906101000a900473010000000000000000000000000000000000000002905090565b600080730100000000000000000000000000000000000000026103db600173010000000000000000000000000000000000000002846103fd565b841672ffffffffffffffffffffffffffffffffffffff19161415905092915050565b60008160ff1660020a83730100000000000000000000000000000000000000900402730100000000000000000000000000000000000000029050929150505600a165627a7a72305820a822b21467e64cbd8de5541834abee600e6db508e580aad706f250d33c6797790029',
          gas: '4700000'
        }, function (e, contract) {
          if (typeof contract.address !== 'undefined') {
            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);

            $start.hide();
            $game.show();

            initGame(contract);
          }
        });
      });

      $join.click(() => {
        $start.hide();
        $game.show();

        web3.eth.defaultAccount = $accountSelect.val();
        const contract = battleshipsContract.at($addressInput.val());
        contract.join();

        initGame(contract);
      });

      const initGame = function (contract) {
        const playerId = contract.whois().c[0];
        const foeId = (playerId + 1) % 2;
        const players = [$redPlayer, $bluePlayer];
        const infoBars = [$redInfoBar, $blueInfoBar];
        const actionBars = [$redActionBar, $blueActionBar];

        $('#game-id').text(`Game ID: ${contract.address}`);

        let [playerStatus, foeStatus] = [false, false];

        const hexDataToBitsArray = (hexData) => {
          hexData = hexData.slice(2).split('');
          let bitsArray = [];

          while (hexData.length !== 0) {
            let bitString = parseInt(hexData.splice(-2).join(''), 16).toString(2);
            bitString = '00000000'.slice(bitString.length, 8) + bitString;
            bitString
              .split('')
              .reverse()
              .forEach(x => x === '0' ? bitsArray.push(false) : bitsArray.push(true));
          }

          return bitsArray;
        };

        const updateState = () => {
          [playerStatus, foeStatus] = contract.getPlayersStatus();

          if (playerStatus) {
            actionBars[playerId]
              .find('[data-role="action-btn"]')
              .remove();
          }

          infoBars[playerId].text(playerStatus ? (contract.myTurn() ? '' : 'Enemy turn') : 'Set your field');
          infoBars[foeId].text((foeStatus && contract.myTurn()) ? 'Make your shot' : '');

          const [playerField, playerShots, foeField, foeShots] = contract.getFields().map(hexDataToBitsArray);

          Array.from(players[playerId].find('td')).forEach((elem, idx) => {
            if (playerField[idx]) {
              $(elem).addClass('populated');
            }
            if (playerShots[idx]) {
              $(elem).addClass('fired');
            }
          });

          Array.from(players[foeId].find('td')).forEach((elem, idx) => {
            if (foeField[idx]) {
              $(elem).addClass('populated');
            }
            if (foeShots[idx]) {
              $(elem).addClass('fired');
            }
          });
        };

        updateState();

        setInterval(updateState, 2000);

        actionBars[playerId].find('[data-role="action-btn"]')
          .text('Submit Field')
          .click(() => {
            let bits = Array.from(players[playerId].find('td'))
              .map(elem => $(elem).hasClass('populated'))
              .concat([false, false, false, false]);

            let hexData = '';

            while (bits.length !== 0) {
              const bitString = bits.splice(0, 8)
                .reverse()
                .map(val => val ? '1' : '0')
                .join('');
              const byte = parseInt(bitString, 2);

              hexData = `${ byte < 16 ? '0' : '' }${byte.toString(16)}${hexData}`;
            }

            hexData = '0x' + hexData;
            console.log(contract.setField(hexData));
            updateState();
          });

        actionBars[foeId].find('[data-role="action-btn"]')
          .text('Fire!')
          .click(() => {
            const $selected = players[foeId].find('.cell.selected');
            if ($selected.length !== 0) {
              const $elem = $($selected[0]);
              contract.makeShot(parseInt($elem.data('cell-id')));
              updateState();
            }
          });

        players[playerId].find('.cell').click(function () {
          if (playerStatus) return;
          let $this = $(this);
          $this.toggleClass('populated');
        });

        const $foeCells = players[foeId].find('.cell');
        $foeCells.click(function () {
          const $this = $(this);
          if ($this.hasClass('selected') || $this.hasClass('fired')) {
            return;
          }
          $foeCells.removeClass('selected');
          $this.toggleClass('selected');
        });
      };
    });
  </script>
</body>
</html>
